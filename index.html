<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CiteCluedo ‚Äì Piloto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #0b1120 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      background: radial-gradient(circle at top left, #111827 0, #020617 60%);
      width: 100%;
      max-width: 560px;
      border-radius: 22px;
      padding: 18px 18px 20px;
      box-shadow:
        0 22px 50px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(31, 41, 55, 0.9);
      position: relative;
      overflow: hidden;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(96, 165, 250, 0.12) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(248, 113, 113, 0.12) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .header {
      position: relative;
      border-radius: 18px;
      padding: 12px 14px 14px;
      margin-bottom: 14px;
      background: linear-gradient(135deg, #020617, #111827);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      box-shadow:
        0 12px 30px rgba(0, 0, 0, 0.75),
        0 0 0 1px rgba(55, 65, 81, 0.8);
    }

    .title-box {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title {
      font-size: 1.7rem;
      font-weight: 900;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .subtitle {
      font-size: 0.85rem;
      opacity: 0.92;
      line-height: 1.3;
    }

    .subtitle span {
      opacity: 0.9;
    }

    .icon {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #facc15 0, #f97316 35%, #b91c1c 80%, #020617 100%);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.9);
      position: relative;
      flex-shrink: 0;
      border: 1px solid rgba(248, 250, 252, 0.1);
    }

    .icon::before,
    .icon::after {
      content: "";
      position: absolute;
      background: #fef9c3;
      border-radius: 999px;
    }

    .icon::before {
      width: 8px;
      height: 20px;
      left: 15px;
      top: 7px;
      transform: rotate(-15deg);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.7);
    }

    .icon::after {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      border: 2px solid #020617;
      top: 22px;
      right: 6px;
      transform: rotate(35deg);
      background: #f9fafb;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: linear-gradient(135deg, #60a5fa, #fb7185);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
    }

    .section-help {
      font-size: 0.8rem;
      color: #cbd5f5;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      font-size: 0.9rem;
      resize: vertical;
      outline: none;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      margin-bottom: 10px;
    }

    textarea::placeholder {
      color: #6b7280;
    }

    textarea:focus {
      border-color: #60a5fa;
      box-shadow:
        0 0 0 1px rgba(96, 165, 250, 0.8),
        0 0 0 4px rgba(30, 64, 175, 0.7);
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      min-width: 120px;
      transition:
        transform 0.05s ease,
        box-shadow 0.05s ease,
        background 0.15s ease,
        color 0.15s ease,
        border-color 0.15s ease,
        opacity 0.1s ease;
    }

    button:active {
      transform: scale(0.97);
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #60a5fa, #fb7185);
      color: #020617;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.9);
    }

    .btn-outline {
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      border: 1px solid #4b5563;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.8rem;
      min-width: 0;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid #4b5563;
      color: #e5e7eb;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
    }

    .btn-small.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }

    .btn-small.success {
      border-color: #15803d;
      color: #bbf7d0;
    }

    .btn-inline-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .view {
      display: none;
      position: relative;
      z-index: 1;
    }

    .view.active {
      display: block;
    }

    .info-box {
      font-size: 0.8rem;
      color: #cbd5f5;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px dashed #4b5563;
      margin-bottom: 10px;
    }

    .list-block {
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.92);
      padding: 8px 10px;
      margin-bottom: 8px;
    }

    .list-block-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    .list-block-body {
      font-size: 0.8rem;
      color: #cbd5f5;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: rgba(15, 23, 42, 0.96);
      font-size: 0.8rem;
      margin: 2px 4px 2px 0;
      color: #e5e7eb;
    }

    .players-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 10px;
    }

    .player-card {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.1s ease, box-shadow 0.1s ease, transform 0.05s ease, border-color 0.1s ease;
      color: #e5e7eb;
    }

    .player-card:active {
      transform: scale(0.97);
    }

    .player-card.active {
      background: #111827;
      border-color: #60a5fa;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.5);
    }

    .cards-view {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .current-turn {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 7px 10px;
      font-size: 0.85rem;
      margin-bottom: 6px;
      background: rgba(15, 23, 42, 0.96);
      outline: none;
      color: #e5e7eb;
    }

    select:focus {
      border-color: #60a5fa;
      box-shadow:
        0 0 0 1px rgba(96, 165, 250, 0.8),
        0 0 0 4px rgba(30, 64, 175, 0.7);
    }

    .status-box {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid #1f2937;
      color: #e5e7eb;
      min-height: 34px;
    }

    .status-box strong {
      font-weight: 700;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      color: #cbd5f5;
      border: 1px solid #4b5563;
    }

    .tag span {
      font-weight: 600;
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
      font-size: 0.78rem;
      color: #9ca3af;
    }

    /* Panel baraja */
    .deck-panel {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 20;
    }

    .deck-panel-inner {
      max-width: 520px;
      width: 100%;
      background: #020617;
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow:
        0 24px 52px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(51, 65, 85, 0.9);
      font-size: 0.82rem;
      color: #e5e7eb;
    }

    .deck-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .deck-panel-title {
      font-weight: 700;
      font-size: 0.9rem;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 420px) {
      .app {
        padding: 14px 12px 16px;
      }
      .title {
        font-size: 1.45rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title-box">
        <div class="title">
          CiteCluedo
          <span>üêæüî™</span>
        </div>
        <div class="subtitle">
          ¬°Oh no, han encontrado al repartidor del catering noqueado!<br>
          <span>Ten√©is que descubrir qui√©n, d√≥nde y con qu√© lo ha hecho.</span>
        </div>
      </div>
      <div class="icon"></div>
    </div>

    <!-- PANEL BARAJA EN JUEGO -->
    <div id="deck-panel" class="deck-panel">
      <div class="deck-panel-inner">
        <div class="deck-panel-header">
          <div class="deck-panel-title">Cartas en juego (partida actual)</div>
          <button id="btn-close-deck" class="btn-small">Cerrar</button>
        </div>
        <div id="deck-panel-content"></div>
      </div>
    </div>

    <!-- VISTA 1: CONFIGURAR -->
    <div id="view-setup" class="view active">
      <div class="section-title">1. Qui√©n juega</div>
      <div class="section-help">
        Escribe los nombres de las personas que participan en esta partida (una por l√≠nea).<br>
        El m√≥vil lo sostiene siempre el terapeuta.<br><br>
        Historia de hoy: el repartidor del catering ha aparecido ‚Äúfuera de juego‚Äù.
        Sabemos que la responsable est√° entre vosotras, en alg√∫n lugar del centro,
        usando uno de los objetos de siempre.
      </div>
      <textarea id="players-input" placeholder="Ejemplo:
Ana
Carla
Luc√≠a
Marta
..."></textarea>

      <div class="info-box">
        El juego elegir√° autom√°ticamente cu√°ntos lugares y objetos usar en funci√≥n del n√∫mero de jugadoras,
        y crear√° un misterio con <strong>persona + lugar + objeto</strong> relacionados con el repartidor del catering.
      </div>

      <button id="btn-create-deck" class="btn-primary">Crear baraja y misterio</button>
    </div>

    <!-- VISTA 2: BARAJA EN JUEGO -->
    <div id="view-deck" class="view">
      <div class="section-title">2. Cartas en juego</div>
      <div class="section-help">
        Estas son las <strong>personas, lugares y objetos</strong> que existen en esta partida.
        El misterio del repartidor del catering se ha creado con una persona, un lugar
        y un objeto de esta lista.
      </div>

      <div id="deck-summary"></div>

      <div class="info-box">
        Todas las jugadoras conocen esta baraja. Lo √∫nico oculto es qui√©n tiene cada carta
        y cu√°les est√°n en el sobre secreto.
      </div>

      <div class="btn-inline-row">
        <button id="btn-to-deal" class="btn-primary">Ir a reparto de cartas</button>
        <button id="btn-back-setup" class="btn-outline">Volver y cambiar jugadoras</button>
      </div>
    </div>

    <!-- VISTA 3: REPARTO DE CARTAS -->
    <div id="view-deal" class="view">
      <div class="section-title">3. Reparto de cartas</div>
      <div class="section-help">
        Toca el nombre de cada jugadora para mostrarle sus cartas en privado.
        Al retirar el m√≥vil o volver a tocar, se ocultan.
      </div>

      <div class="players-list" id="deal-players-list"></div>

      <div class="info-box">
        Cada jugadora suele tener entre 1 y 3 cartas. Pueden comentar entre ellas qu√© han visto,
        pero la informaci√≥n clave es deducir qu√© no aparece nunca.
      </div>

      <div class="btn-inline-row">
        <button id="btn-start-game" class="btn-primary">Empezar partida</button>
        <button id="btn-show-deck-from-deal" class="btn-outline">Ver cartas en juego</button>
      </div>
    </div>

    <!-- VISTA 4: TURNOS -->
    <div id="view-turns" class="view">
      <div class="section-title">4. Turnos y acusaciones</div>
      <div class="section-help">
        En cada turno, la jugadora de turno puede hacer una <strong>acusaci√≥n normal</strong> (para recabar informaci√≥n)
        o una <strong>acusaci√≥n final</strong> si cree saber la soluci√≥n del caso del catering.
      </div>

      <div class="current-turn">
        Turno de: <span id="current-player-label"></span>
      </div>

      <div class="info-box">
        <strong>Acusaci√≥n normal:</strong> la jugadora de turno dice una persona, un lugar y un objeto.
        La app guiar√° la refutaci√≥n preguntando en orden qui√©n puede refutar.
      </div>

      <div class="list-block">
        <div class="list-block-title">Acusaci√≥n actual</div>
        <div>
          <select id="select-person"></select>
          <select id="select-place"></select>
          <select id="select-object"></select>
        </div>
        <div class="btn-inline-row">
          <button id="btn-start-refutation" class="btn-primary">Iniciar refutaci√≥n</button>
          <button id="btn-final-accusation" class="btn-outline">Acusaci√≥n final</button>
        </div>
      </div>

      <div class="list-block">
        <div class="list-block-title">Refutaci√≥n</div>
        <div id="refutation-area" class="status-box">
          A√∫n no se ha iniciado ninguna acusaci√≥n en este turno.
        </div>
        <div id="refutation-buttons" class="btn-inline-row hidden">
          <button id="btn-refute-yes" class="btn-small success">Puede refutar</button>
          <button id="btn-refute-no" class="btn-small">No puede</button>
        </div>
      </div>

      <div class="list-block">
        <div class="list-block-title">Resultado acusaci√≥n final</div>
        <div id="final-accusation-result" class="status-box">
          Aqu√≠ aparecer√° si la acusaci√≥n final acierta o no el misterio del repartidor del catering.
        </div>
      </div>

      <div class="footer-row">
        <div class="tag"><span>‚Ñπ</span> Versi√≥n piloto: nadie queda eliminado aunque falle la acusaci√≥n final.</div>
        <div class="btn-inline-row">
          <button id="btn-next-turn" class="btn-small">Siguiente turno</button>
          <button id="btn-show-deck-from-turns" class="btn-small">Ver cartas en juego</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // BANCO BASE
    // ==========================
    const BASE_OBJECTS = [
      "Reloj cocina",
      "Planes de vida",
      "Taza azul",
      "Taza rosa",
      "Escobilla del v√°ter",
      "Enchufe de ordenador",
      "Tenedor",
      "Bol√≠grafo de Citema",
      "Mando de la tele",
      "Mando del aire acondicionado",
      "Pulpito contento",
      "Aguja de crochet",
      "Esterilla",
      "Estatua de Gato",
      "Jarra",
      "Maceta",
      "Llaves de cerezas",
      "Teclado de piano",
      "Cuchara",
      "Manta"
    ];

    const BASE_LOCATIONS = [
      "Comedor",
      "Cocina",
      "Sal√≥n",
      "Armario",
      "Sala privada",
      "Despensa",
      "Sala de estudio",
      "Ba√±o de arriba",
      "Ba√±o de abajo",
      "Escalera",
      "Entrada",
      "Pasillo",
      "Despacho de arriba",
      "Despacho de abajo",
      "Almac√©n de los de pr√°cticas",
      "Sala de biombos"
    ];

    // ==========================
    // ESTADO
    // ==========================
    let players = [];
    let locationsInPlay = [];
    let objectsInPlay = [];
    let envelope = null;
    let playerCards = {};
    let currentTurnIndex = 0;

    let refutationActive = false;
    let refutationOrder = [];
    let refutationIndex = 0;
    let currentAccusation = null;

    // ==========================
    // UTILIDADES
    // ==========================
    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function showView(viewId) {
      ["view-setup", "view-deck", "view-deal", "view-turns"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove("active");
      });
      const target = document.getElementById(viewId);
      if (target) {
        target.classList.add("active");
      }
    }

    function createDeckAndMystery() {
      const input = document.getElementById("players-input").value;
      const rawLines = input.split("\n").map(l => l.trim()).filter(Boolean);
      const unique = [];
      rawLines.forEach(name => {
        if (!unique.includes(name)) unique.push(name);
      });
      if (unique.length < 3) {
        alert("Necesitas al menos 3 jugadoras para crear el misterio.");
        return;
      }
      players = unique;

      const P = players.length;
      let numLocations;
      let numObjects;

      if (P <= 5) {
        numLocations = 3;
        numObjects = 3;
      } else if (P <= 10) {
        numLocations = 4;
        numObjects = 4;
      } else {
        numLocations = 5;
        numObjects = 5;
      }

      numLocations = Math.min(numLocations, BASE_LOCATIONS.length);
      numObjects = Math.min(numObjects, BASE_OBJECTS.length);

      locationsInPlay = shuffle(BASE_LOCATIONS).slice(0, numLocations);
      objectsInPlay = shuffle(BASE_OBJECTS).slice(0, numObjects);

      const suspect = players[Math.floor(Math.random() * players.length)];
      const locationSecret = locationsInPlay[Math.floor(Math.random() * locationsInPlay.length)];
      const objectSecret = objectsInPlay[Math.floor(Math.random() * objectsInPlay.length)];

      envelope = {
        person: suspect,
        place: locationSecret,
        object: objectSecret
      };

      const personsForDeck = players.filter(p => p !== envelope.person);
      const locationsForDeck = locationsInPlay.filter(l => l !== envelope.place);
      const objectsForDeck = objectsInPlay.filter(o => o !== envelope.object);

      let deck = personsForDeck.concat(locationsForDeck, objectsForDeck);
      deck = shuffle(deck);

      playerCards = {};
      players.forEach(p => { playerCards[p] = []; });

      let idx = 0;
      while (deck.length > 0) {
        const card = deck.shift();
        const player = players[idx % players.length];
        playerCards[player].push(card);
        idx++;
      }

      renderDeckSummary();
      showView("view-deck");
    }

    function renderDeckSummary() {
      const container = document.getElementById("deck-summary");
      const totalCards = players.length + locationsInPlay.length + objectsInPlay.length;
      const cardsDealt = totalCards - 3;

      let html = "";
      html += `<div class="list-block">
        <div class="list-block-title">Resumen r√°pido</div>
        <div class="list-block-body">
          Personas en juego: <strong>${players.length}</strong><br>
          Lugares en juego: <strong>${locationsInPlay.length}</strong><br>
          Objetos en juego: <strong>${objectsInPlay.length}</strong><br>
          Total cartas en baraja: <strong>${totalCards}</strong> (3 en el sobre, <strong>${cardsDealt}</strong> repartidas).
        </div>
      </div>`;

      html += `<div class="list-block">
        <div class="list-block-title">Personas</div>
        <div class="list-block-body">`;
      players.forEach(p => {
        html += `<span class="chip">${p}</span>`;
      });
      html += `</div></div>`;

      html += `<div class="list-block">
        <div class="list-block-title">Lugares</div>
        <div class="list-block-body">`;
      locationsInPlay.forEach(l => {
        html += `<span class="chip">${l}</span>`;
      });
      html += `</div></div>`;

      html += `<div class="list-block">
        <div class="list-block-title">Objetos</div>
        <div class="list-block-body">`;
      objectsInPlay.forEach(o => {
        html += `<span class="chip">${o}</span>`;
      });
      html += `</div></div>`;

      container.innerHTML = html;
    }

    function renderDealPlayers() {
      const container = document.getElementById("deal-players-list");
      container.innerHTML = "";

      players.forEach(name => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "player-card";
        cardDiv.textContent = name;

        const cardsDiv = document.createElement("div");
        cardsDiv.className = "cards-view hidden";
        const cards = playerCards[name] || [];
        if (cards.length === 0) {
          cardsDiv.textContent = "Sin cartas.";
        } else {
          cardsDiv.innerHTML = "Cartas: " + cards.map(c => `<span class="chip">${c}</span>`).join(" ");
        }

        cardDiv.addEventListener("click", () => {
          const isActive = cardDiv.classList.contains("active");
          document.querySelectorAll(".player-card").forEach(el => el.classList.remove("active"));
          document.querySelectorAll(".cards-view").forEach(el => el.classList.add("hidden"));

          if (!isActive) {
            cardDiv.classList.add("active");
            cardsDiv.classList.remove("hidden");
          }
        });

        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.appendChild(cardDiv);
        wrapper.appendChild(cardsDiv);

        container.appendChild(wrapper);
      });
    }

    function setupTurnView() {
      currentTurnIndex = 0;
      updateCurrentPlayerLabel();
      populateSelects();
      resetTurnStatus();
    }

    function updateCurrentPlayerLabel() {
      const label = document.getElementById("current-player-label");
      label.textContent = players[currentTurnIndex] || "";
    }

    function populateSelects() {
      const selPerson = document.getElementById("select-person");
      const selPlace = document.getElementById("select-place");
      const selObject = document.getElementById("select-object");

      selPerson.innerHTML = "";
      players.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        selPerson.appendChild(opt);
      });

      selPlace.innerHTML = "";
      locationsInPlay.forEach(l => {
        const opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        selPlace.appendChild(opt);
      });

      selObject.innerHTML = "";
      objectsInPlay.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        selObject.appendChild(opt);
      });
    }

    function resetTurnStatus() {
      refutationActive = false;
      refutationOrder = [];
      refutationIndex = 0;
      currentAccusation = null;

      const refArea = document.getElementById("refutation-area");
      const refButtons = document.getElementById("refutation-buttons");
      refArea.innerHTML = "A√∫n no se ha iniciado ninguna acusaci√≥n en este turno.";
      refButtons.classList.add("hidden");
    }

    function startRefutation() {
      if (refutationActive) return;

      const person = document.getElementById("select-person").value;
      const place = document.getElementById("select-place").value;
      const object = document.getElementById("select-object").value;
      const accuserIndex = currentTurnIndex;
      const accuser = players[accuserIndex];

      currentAccusation = { person, place, object, accuserIndex };

      refutationOrder = [];
      for (let i = 1; i < players.length; i++) {
        const idx = (accuserIndex + i) % players.length;
        refutationOrder.push(idx);
      }
      refutationIndex = 0;
      refutationActive = true;

      const refArea = document.getElementById("refutation-area");
      const refButtons = document.getElementById("refutation-buttons");

      if (refutationOrder.length === 0) {
        refArea.innerHTML = "No hay m√°s jugadoras para refutar.";
        refButtons.classList.add("hidden");
        refutationActive = false;
        return;
      }

      const firstIdx = refutationOrder[0];
      refArea.innerHTML = `Acusaci√≥n de <strong>${accuser}</strong>: <em>${person}</em>, <em>${place}</em>, <em>${object}</em>.<br><br>
      Pregunta al grupo, empezando por <strong>${players[firstIdx]}</strong>: ¬øpuede refutar alguna de estas tres cartas?`;
      refButtons.classList.remove("hidden");
    }

    function handleRefute(canRefute) {
      if (!refutationActive || !currentAccusation) return;

      const refArea = document.getElementById("refutation-area");
      const refButtons = document.getElementById("refutation-buttons");

      if (refutationIndex >= refutationOrder.length) {
        refArea.innerHTML = `Nadie ha podido refutar esta acusaci√≥n. Esto da informaci√≥n importante para la deducci√≥n.`;
        refButtons.classList.add("hidden");
        refutationActive = false;
        return;
      }

      const idx = refutationOrder[refutationIndex];
      const playerName = players[idx];

      if (canRefute) {
        refArea.innerHTML = `<strong>${playerName}</strong> puede refutar la acusaci√≥n (tiene al menos una de esas cartas).<br>
        La carta concreta se mantiene en secreto; solo la acusadora puede conocerla si la jugadora decide mostr√°rsela.`;
        refButtons.classList.add("hidden");
        refutationActive = false;
        return;
      } else {
        refutationIndex++;
        if (refutationIndex >= refutationOrder.length) {
          refArea.innerHTML = `Nadie ha podido refutar esta acusaci√≥n. Esto da informaci√≥n importante para la deducci√≥n.`;
          refButtons.classList.add("hidden");
          refutationActive = false;
          return;
        } else {
          const nextIdx = refutationOrder[refutationIndex];
          const nextName = players[nextIdx];
          refArea.innerHTML = `Seguimos con la acusaci√≥n de <strong>${players[currentAccusation.accuserIndex]}</strong>: <em>${currentAccusation.person}</em>, <em>${currentAccusation.place}</em>, <em>${currentAccusation.object}</em>.<br><br>
          Pregunta a <strong>${nextName}</strong>: ¬øpuede refutar alguna de estas tres cartas?`;
        }
      }
    }

    function handleFinalAccusation() {
      const person = document.getElementById("select-person").value;
      const place = document.getElementById("select-place").value;
      const object = document.getElementById("select-object").value;
      const accuser = players[currentTurnIndex];

      const resultBox = document.getElementById("final-accusation-result");

      if (!envelope) {
        resultBox.innerHTML = "Todav√≠a no se ha creado ning√∫n misterio.";
        return;
      }

      const correctPerson = person === envelope.person;
      const correctPlace = place === envelope.place;
      const correctObject = object === envelope.object;

      if (correctPerson && correctPlace && correctObject) {
        resultBox.innerHTML = `<strong>${accuser}</strong> ha resuelto el caso del repartidor del catering üéâ<br>
        Era <strong>${envelope.person}</strong>, en <strong>${envelope.place}</strong>, con <strong>${envelope.object}</strong>.`;
      } else {
        resultBox.innerHTML = `<strong>${accuser}</strong> no ha acertado el misterio del repartidor del catering.<br>
        En esta versi√≥n piloto, puede seguir participando, pero el grupo sabe que esa combinaci√≥n no es correcta.`;
      }
    }

    function nextTurn() {
      currentTurnIndex = (currentTurnIndex + 1) % players.length;
      updateCurrentPlayerLabel();
      resetTurnStatus();
    }

    // Panel baraja
    function openDeckPanel() {
      const panel = document.getElementById("deck-panel");
      const content = document.getElementById("deck-panel-content");
      if (!players.length) {
        content.innerHTML = "Todav√≠a no se ha creado ninguna partida.";
      } else {
        let html = "";
        html += `<div class="list-block">
          <div class="list-block-title">Personas</div>
          <div class="list-block-body">`;
        players.forEach(p => {
          html += `<span class="chip">${p}</span>`;
        });
        html += `</div></div>`;

        html += `<div class="list-block">
          <div class="list-block-title">Lugares</div>
          <div class="list-block-body">`;
        locationsInPlay.forEach(l => {
          html += `<span class="chip">${l}</span>`;
        });
        html += `</div></div>`;

        html += `<div class="list-block">
          <div class="list-block-title">Objetos</div>
          <div class="list-block-body">`;
        objectsInPlay.forEach(o => {
          html += `<span class="chip">${o}</span>`;
        });
        html += `</div></div>`;

        content.innerHTML = html;
      }
      panel.style.display = "flex";
    }

    function closeDeckPanel() {
      const panel = document.getElementById("deck-panel");
      panel.style.display = "none";
    }

    // ==========================
    // EVENTOS
    // ==========================
    document.getElementById("btn-create-deck").addEventListener("click", createDeckAndMystery);

    document.getElementById("btn-to-deal").addEventListener("click", () => {
      renderDealPlayers();
      showView("view-deal");
    });

    document.getElementById("btn-back-setup").addEventListener("click", () => {
      showView("view-setup");
    });

    document.getElementById("btn-start-game").addEventListener("click", () => {
      setupTurnView();
      showView("view-turns");
    });

    document.getElementById("btn-start-refutation").addEventListener("click", startRefutation);
    document.getElementById("btn-refute-yes").addEventListener("click", () => handleRefute(true));
    document.getElementById("btn-refute-no").addEventListener("click", () => handleRefute(false));

    document.getElementById("btn-final-accusation").addEventListener("click", handleFinalAccusation);
    document.getElementById("btn-next-turn").addEventListener("click", nextTurn);

    document.getElementById("btn-show-deck-from-deal").addEventListener("click", openDeckPanel);
    document.getElementById("btn-show-deck-from-turns").addEventListener("click", openDeckPanel);
    document.getElementById("btn-close-deck").addEventListener("click", closeDeckPanel);

    // Inicio
    showView("view-setup");
  </script>
</body>
</html>
